<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>خريطة مناطق قطر التفاعلية</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    :root {
      --primary-color: #8B1538;
      --secondary-color: #FFFFFF;
      --accent-color: #FFD700;
      --dark-color: #2C3E50;
      --light-gray: #F8F9FA;
      --shadow-light: rgba(139, 21, 56, 0.1);
      --shadow-medium: rgba(139, 21, 56, 0.2);
      --shadow-heavy: rgba(139, 21, 56, 0.3);
      --gradient-primary: linear-gradient(135deg, #8B1538 0%, #A91B47 100%);
      --gradient-secondary: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      direction: rtl;
      font-family: 'Cairo', 'Segoe UI', sans-serif;
      background: var(--light-gray);
      overflow: hidden;
    }

    #map {
      width: 100%;
      height: 100vh;
      position: relative;
    }

    /* Header */
    .header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1001;
      background: var(--gradient-primary);
      color: white;
      padding: 15px 20px;
      box-shadow: 0 4px 20px var(--shadow-medium);
      backdrop-filter: blur(10px);
    }

    .header h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
      text-align: center;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .header .subtitle {
      text-align: center;
      font-size: 14px;
      margin-top: 5px;
      opacity: 0.9;
      font-weight: 300;
    }

    /* Search Box */
    #search-container {
      position: absolute;
      top: 120px;
      right: 20px;
      z-index: 1000;
      width: 320px;
      max-width: calc(100vw - 40px);
    }

    #search-box {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(15px);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 8px 32px var(--shadow-light);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }

    #search-box:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px var(--shadow-medium);
    }

    .search-input-container {
      position: relative;
      margin-bottom: 15px;
    }

    #zone-input {
      width: 100%;
      padding: 15px 20px 15px 50px;
      font-size: 16px;
      border: 2px solid transparent;
      border-radius: 15px;
      background: var(--light-gray);
      font-family: 'Cairo', sans-serif;
      transition: all 0.3s ease;
      outline: none;
    }

    #zone-input:focus {
      border-color: var(--primary-color);
      background: white;
      box-shadow: 0 0 0 4px var(--shadow-light);
    }

    .search-icon {
      position: absolute;
      right: 18px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--primary-color);
      font-size: 18px;
    }

    #zone-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 250px;
      overflow-y: auto;
      border-radius: 12px;
      background: white;
      box-shadow: inset 0 2px 8px rgba(0,0,0,0.05);
    }

    #zone-list::-webkit-scrollbar {
      width: 6px;
    }

    #zone-list::-webkit-scrollbar-track {
      background: var(--light-gray);
      border-radius: 3px;
    }

    #zone-list::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 3px;
    }

    #zone-list li {
      padding: 15px 18px;
      font-size: 15px;
      cursor: pointer;
      border-bottom: 1px solid rgba(139, 21, 56, 0.1);
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    #zone-list li:last-child {
      border-bottom: none;
    }

    #zone-list li:hover {
      background: var(--gradient-primary);
      color: white;
      transform: translateX(-5px);
    }

    .zone-number {
      background: var(--gradient-secondary);
      color: var(--dark-color);
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      min-width: 40px;
      text-align: center;
    }

    /* Loading Spinner */
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1002;
      background: rgba(255, 255, 255, 0.95);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 8px 32px var(--shadow-medium);
      text-align: center;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid var(--light-gray);
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Custom Popup Styles */
    .leaflet-popup-content-wrapper {
      background: var(--gradient-primary);
      color: white;
      border-radius: 15px;
      box-shadow: 0 8px 32px var(--shadow-medium);
      border: none;
    }

    .leaflet-popup-content {
      text-align: right;
      font-size: 16px;
      font-family: 'Cairo', sans-serif;
      margin: 20px;
      line-height: 1.6;
    }

    .leaflet-popup-tip {
      background: var(--primary-color);
      border: none;
    }

    .popup-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 10px;
      color: var(--accent-color);
    }

    .popup-zone {
      font-size: 14px;
      opacity: 0.9;
    }

    /* Error Message */
    .error-message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1002;
      background: #FF6B6B;
      color: white;
      padding: 20px 30px;
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(255, 107, 107, 0.3);
      text-align: center;
      font-family: 'Cairo', sans-serif;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .header h1 {
        font-size: 20px;
      }
      
      .header .subtitle {
        font-size: 12px;
      }
      
      #search-container {
        top: 100px;
        right: 10px;
        left: 10px;
        width: auto;
      }
      
      #search-box {
        padding: 15px;
      }
      
      #zone-input {
        padding: 12px 15px 12px 40px;
        font-size: 14px;
      }
      
      .search-icon {
        right: 15px;
        font-size: 16px;
      }
      
      #zone-list li {
        padding: 12px 15px;
        font-size: 14px;
      }
    }

    @media (max-width: 480px) {
      .header {
        padding: 10px 15px;
      }
      
      .header h1 {
        font-size: 18px;
      }
      
      #search-container {
        top: 85px;
      }
    }

    /* Animation Classes */
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .bounce-in {
      animation: bounceIn 0.6s ease-out;
    }

    @keyframes bounceIn {
      0% { transform: scale(0.3); opacity: 0; }
      50% { transform: scale(1.05); }
      70% { transform: scale(0.9); }
      100% { transform: scale(1); opacity: 1; }
    }
  </style>
</head>
<body>

<div class="header">
  <h1><i class="fas fa-map-marked-alt"></i> خريطة مناطق قطر التفاعلية</h1>
  <div class="subtitle">استكشف جميع المناطق والمحافظات في دولة قطر</div>
</div>

<div id="map"></div>

<div id="search-container">
  <div id="search-box" class="fade-in">
    <div class="search-input-container">
      <i class="fas fa-search search-icon"></i>
      <input type="text" id="zone-input" placeholder="ابحث عن المنطقة أو الرقم..." />
    </div>
    <ul id="zone-list"></ul>
  </div>
</div>

<div id="loading" class="loading" style="display: none;">
  <div class="spinner"></div>
  <div>جاري تحميل البيانات...</div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyD3hShBlWYIFkhlpxezZi7ZsNoWUFoWQF4",
    authDomain: "delivery-tracker-a5493.firebaseapp.com",
    databaseURL: "https://delivery-tracker-a5493-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "delivery-tracker-a5493",
    storageBucket: "delivery-tracker-a5493.appspot.com",
    messagingSenderId: "168628360237",
    appId: "1:168628360237:web:b1657657eb8a19fe6054a4",
    measurementId: "G-YV01JCQ9WE"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Global variables - make them accessible from window object
  let map;
  let zoneLayerGroup;
  let highlightLayer;
  const zones = [];

  // Make zones accessible globally for debugging
  window.zones = zones;
  window.searchZones = searchZones;

  // DOM Elements
  const loadingElement = document.getElementById("loading");
  const zoneInput = document.getElementById("zone-input");
  const zoneList = document.getElementById("zone-list");
  const searchBox = document.getElementById("search-box");
  
  // Show loading
  function showLoading() {
    loadingElement.style.display = "block";
    loadingElement.classList.add("bounce-in");
  }

  // Hide loading
  function hideLoading() {
    loadingElement.style.display = "none";
  }

  // Show error
  function showError(message) {
    hideLoading();
    const errorDiv = document.createElement("div");
    errorDiv.className = "error-message bounce-in";
    errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i><br>${message}`;
    document.body.appendChild(errorDiv);
    
    setTimeout(() => {
      if (document.body.contains(errorDiv)) {
        document.body.removeChild(errorDiv);
      }
    }, 5000);
  }

  // Initialize Leaflet Map
  function initializeMap() {
    try {
      map = L.map('map', {
        center: [25.3, 51.5],
        zoom: 10,
        zoomControl: false
      });

      // Add custom zoom control
      L.control.zoom({
        position: 'bottomleft'
      }).addTo(map);

      // Custom tile layer with better styling
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 18
      }).addTo(map);

      // Initialize layer groups
      zoneLayerGroup = L.geoJSON(null, {
        style: function(feature) {
          return {
            color: "#8B1538",
            weight: 2,
            fillOpacity: 0.1,
            fillColor: "#8B1538"
          };
        },
        onEachFeature: function(feature, layer) {
          layer.on('mouseover', function() {
            this.setStyle({
              weight: 3,
              fillOpacity: 0.3
            });
          });
          
          layer.on('mouseout', function() {
            this.setStyle({
              weight: 2,
              fillOpacity: 0.1
            });
          });
          
          layer.on('click', function() {
            highlightFeature(feature);
          });
        }
      }).addTo(map);

      highlightLayer = L.geoJSON(null, {
        style: {
          color: "#FFD700",
          weight: 4,
          fillOpacity: 0.4,
          fillColor: "#FFD700"
        }
      }).addTo(map);

      console.log("Map initialized successfully");

    } catch (error) {
      console.error("Error initializing map:", error);
      showError("خطأ في تحميل الخريطة");
    }
  }

  // Load zone data from Firebase
  async function loadZones() {
    showLoading();
    
    try {
      console.log("Loading zones from Firebase...");
      const snapshot = await get(child(ref(db), 'areas'));
      
      if (!snapshot.exists()) {
        throw new Error("لا توجد بيانات متاحة");
      }

      const areas = snapshot.val();
      let loadedCount = 0;
      
      // Clear existing zones
      zones.length = 0;
      
      for (let id in areas) {
        try {
          const area = areas[id];

          // Validate area data
          if (!area.geometry) {
            console.warn(`Missing geometry for area ${id}`);
            continue;
          }

          // Extract properties with safe defaults
          let arabic = area.region || area.properties?.["المنطقة"] || "غير معروف";
          let english = area.english_name || "غير متوفر";
          let zone = area.name || area.properties?.["الاسم"] || area.zone || "غير معروف";

          // Fix specific data inconsistencies - using == for loose comparison to handle both string and number
          if (zone === "الجسرة" && arabic == 1) {
            arabic = "الجسرة";
            zone = "1";
            console.log("Fixed Jasra data: arabic=1, zone=الجسرة -> arabic=الجسرة, zone=1");
          } else if (zone === "البدع" && arabic == 2) {
            arabic = "البدع";
            zone = "2";
            console.log("Fixed Badea data: arabic=2, zone=البدع -> arabic=البدع, zone=2");
          } else if (zone === "مشيرب") {
            if (arabic == 3) {
              arabic = "مشيرب 3";
              zone = "3";
              console.log("Fixed Musheireb 3 data");
            } else if (arabic == 4) {
              arabic = "مشيرب 4";
              zone = "4";
              console.log("Fixed Musheireb 4 data");
            }
          }

          const feature = {
            type: "Feature",
            geometry: area.geometry,
            properties: {
              id: area.id || id,
              arabic: arabic,
              english: english,
              zone: zone
            }
          };

          zones.push(feature);
          zoneLayerGroup.addData(feature);
          loadedCount++;
          
        } catch (error) {
          console.warn(`Error processing area ${id}:`, error);
        }
      }

      if (loadedCount === 0) {
        throw new Error("لم يتم تحميل أي منطقة بنجاح");
      }

      console.log(`Loaded ${loadedCount} zones successfully`);
      
      // Log fixed zones for verification
      const jasra = zones.find(z => z.properties.arabic === "الجسرة");
      if (jasra) {
        console.log("Jasra zone verified:", jasra.properties);
      } else {
        console.warn("Jasra zone not found after loading");
      }
      
      hideLoading();
      
    } catch (error) {
      console.error("Error loading zones:", error);
      showError("خطأ في تحميل بيانات المناطق: " + error.message);
    }
  }

  // Improved search function with exact number matching
  function searchZones(query) {
    if (!query || query.trim() === '') {
      return [];
    }
    
    const searchTerm = query.trim().toLowerCase();
    
    try {
      const filtered = zones.filter(f => {
        // Safe string conversion and null checking
        const arabic = (f.properties.arabic || '').toString().toLowerCase();
        const english = (f.properties.english || '').toString().toLowerCase();
        const zone = (f.properties.zone || '').toString();
        
        // Check for exact number match first (highest priority)
        if (/^\d+$/.test(searchTerm)) {
          // If search term is a pure number, check for exact zone match
          if (zone === searchTerm) {
            return true;
          }
          // Also check if zone contains the number (for partial matches)
          if (zone.includes(searchTerm)) {
            return true;
          }
        }
        
        // Then check for text matches
        return (
          arabic.includes(searchTerm) ||
          english.includes(searchTerm) ||
          zone.toLowerCase().includes(searchTerm)
        );
      });

      // Sort results with improved logic
      filtered.sort((a, b) => {
        const aArabic = (a.properties.arabic || '').toString().toLowerCase();
        const bArabic = (b.properties.arabic || '').toString().toLowerCase();
        const aZone = (a.properties.zone || '').toString();
        const bZone = (b.properties.zone || '').toString();
        
        // If searching for a number, prioritize exact zone matches
        if (/^\d+$/.test(searchTerm)) {
          if (aZone === searchTerm && bZone !== searchTerm) return -1;
          if (bZone === searchTerm && aZone !== searchTerm) return 1;
          
          // Then prioritize zones that start with the number
          const aStarts = aZone.startsWith(searchTerm);
          const bStarts = bZone.startsWith(searchTerm);
          if (aStarts && !bStarts) return -1;
          if (bStarts && !aStarts) return 1;
        }
        
        // Then sort by text relevance
        const aMatch = aArabic.indexOf(searchTerm);
        const bMatch = bArabic.indexOf(searchTerm);
        if (aMatch !== -1 && bMatch === -1) return -1;
        if (bMatch !== -1 && aMatch === -1) return 1;
        if (aMatch !== bMatch) return aMatch - bMatch;
        
        // Finally sort alphabetically
        return aArabic.localeCompare(bArabic);
      });

      return filtered;
    } catch (error) {
      console.error("Error in search function:", error);
      return [];
    }
  }

  // Handle search with improved filtering
  function handleSearch() {
    const query = zoneInput.value.trim();
    zoneList.innerHTML = "";

    if (!query) {
      return;
    }

    console.log(`Searching for: "${query}"`);
    
    try {
      const filtered = searchZones(query);
      console.log(`Found ${filtered.length} results`);

      // Limit results to prevent performance issues
      const maxResults = 10;
      const limitedResults = filtered.slice(0, maxResults);

      for (let feature of limitedResults) {
        const item = document.createElement("li");
        item.innerHTML = `
          <span>${feature.properties.arabic || 'غير معروف'}</span>
          <span class="zone-number">${feature.properties.zone || 'غير معروف'}</span>
        `;
        
        item.addEventListener("click", () => {
          highlightFeature(feature);
          zoneList.innerHTML = "";
          zoneInput.value = "";
          zoneInput.blur(); // Hide mobile keyboard
        });
        
        zoneList.appendChild(item);
      }

      if (filtered.length > maxResults) {
        const moreItem = document.createElement("li");
        moreItem.innerHTML = `<span style="opacity: 0.7; font-style: italic;">و ${filtered.length - maxResults} نتيجة أخرى...</span>`;
        moreItem.style.cursor = "default";
        zoneList.appendChild(moreItem);
      }

      if (filtered.length === 0) {
        const noResultsItem = document.createElement("li");
        noResultsItem.innerHTML = `<span style="opacity: 0.7; font-style: italic;">لا توجد نتائج</span>`;
        noResultsItem.style.cursor = "default";
        zoneList.appendChild(noResultsItem);
      }
    } catch (error) {
      console.error("Error in handleSearch:", error);
      const errorItem = document.createElement("li");
      errorItem.innerHTML = `<span style="color: red; font-style: italic;">خطأ في البحث</span>`;
      errorItem.style.cursor = "default";
      zoneList.appendChild(errorItem);
    }
  }

  // Highlight feature with improved animation
  function highlightFeature(feature) {
    try {
      highlightLayer.clearLayers();
      highlightLayer.addData(feature);

      const bounds = L.geoJSON(feature).getBounds();
      map.fitBounds(bounds, { 
        padding: [50, 50],
        maxZoom: 13
      });

      // Add popup with enhanced content
      setTimeout(() => {
        const center = bounds.getCenter();
        const popupContent = `
          <div class="popup-title">${feature.properties.arabic || 'غير معروف'}</div>
          <div class="popup-zone">رقم المنطقة: ${feature.properties.zone || 'غير معروف'}</div>
          ${feature.properties.english && feature.properties.english !== "غير متوفر" ? 
            `<div style="margin-top: 8px; opacity: 0.8;">${feature.properties.english}</div>` : 
            ''
          }
        `;
        
        L.popup({
          closeButton: true,
          autoClose: false,
          className: 'custom-popup'
        })
          .setLatLng(center)
          .setContent(popupContent)
          .openOn(map);
      }, 500);
      
    } catch (error) {
      console.error("Error highlighting feature:", error);
      showError("خطأ في عرض المنطقة");
    }
  }

  // Event listeners
  zoneInput.addEventListener("input", handleSearch);
  
  // Handle Enter key
  zoneInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      const firstResult = zoneList.querySelector("li");
      if (firstResult && !firstResult.textContent.includes("لا توجد نتائج") && !firstResult.textContent.includes("نتيجة أخرى")) {
        firstResult.click();
      }
    }
  });

  // Clear search when clicking outside
  document.addEventListener("click", (e) => {
    if (!searchBox.contains(e.target)) {
      zoneList.innerHTML = "";
    }
  });

  // Initialize application
  async function init() {
    try {
      console.log("Initializing application...");
      initializeMap();
      await loadZones();
      console.log("Application initialized successfully");
    } catch (error) {
      console.error("Initialization error:", error);
      showError("خطأ في تشغيل التطبيق");
    }
  }

  // Start the application
  init();
</script>

</body>
</html>

