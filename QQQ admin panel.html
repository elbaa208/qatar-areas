<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>لوحة إدارة مناطق قطر</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css"/>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    :root {
      --primary-color: #8B1538;
      --secondary-color: #FFFFFF;
      --accent-color: #FFD700;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --info-color: #17a2b8;
      --dark-color: #2C3E50;
      --light-gray: #F8F9FA;
      --medium-gray: #6C757D;
      --border-color: #DEE2E6;
      --shadow-light: rgba(139, 21, 56, 0.1);
      --shadow-medium: rgba(139, 21, 56, 0.2);
      --shadow-heavy: rgba(139, 21, 56, 0.3);
      --gradient-primary: linear-gradient(135deg, #8B1538 0%, #A91B47 100%);
      --gradient-secondary: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      direction: rtl;
      font-family: 'Cairo', 'Segoe UI', sans-serif;
      background: var(--light-gray);
    }

    /* Header */
    .header {
      background: var(--gradient-primary);
      color: white;
      padding: 20px;
      box-shadow: 0 4px 20px var(--shadow-medium);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .header h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 700;
      text-align: center;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .header .subtitle {
      text-align: center;
      font-size: 16px;
      margin-top: 8px;
      opacity: 0.9;
      font-weight: 300;
    }

    /* Main Layout */
    .main-container {
      display: flex;
      height: calc(100vh - 120px);
      gap: 20px;
      padding: 20px;
    }

    /* Sidebar */
    .sidebar {
      width: 400px;
      background: white;
      border-radius: 20px;
      box-shadow: 0 8px 32px var(--shadow-light);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      background: var(--gradient-secondary);
      color: var(--dark-color);
      padding: 20px;
      font-size: 20px;
      font-weight: 600;
      text-align: center;
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    /* Tabs */
    .tabs {
      display: flex;
      margin-bottom: 20px;
      background: var(--light-gray);
      border-radius: 12px;
      padding: 4px;
    }

    .tab {
      flex: 1;
      padding: 12px 16px;
      text-align: center;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      font-size: 14px;
    }

    .tab.active {
      background: var(--primary-color);
      color: white;
      box-shadow: 0 2px 8px var(--shadow-light);
    }

    .tab:not(.active):hover {
      background: rgba(139, 21, 56, 0.1);
    }

    /* Tab Content */
    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Form Styles */
    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark-color);
      font-size: 14px;
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border-color);
      border-radius: 12px;
      font-size: 14px;
      font-family: 'Cairo', sans-serif;
      transition: all 0.3s ease;
      background: white;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 4px var(--shadow-light);
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    /* Buttons */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Cairo', sans-serif;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }

    .btn-primary {
      background: var(--gradient-primary);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px var(--shadow-medium);
    }

    .btn-success {
      background: var(--success-color);
      color: white;
    }

    .btn-success:hover {
      background: #218838;
      transform: translateY(-2px);
    }

    .btn-danger {
      background: var(--danger-color);
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
      transform: translateY(-2px);
    }

    .btn-warning {
      background: var(--warning-color);
      color: var(--dark-color);
    }

    .btn-warning:hover {
      background: #e0a800;
      transform: translateY(-2px);
    }

    .btn-full {
      width: 100%;
      justify-content: center;
    }

    .btn-sm {
      padding: 8px 16px;
      font-size: 12px;
    }

    /* Zone List */
    .zone-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .zone-item {
      background: white;
      border: 2px solid var(--border-color);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .zone-item:hover {
      border-color: var(--primary-color);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px var(--shadow-light);
    }

    .zone-item.selected {
      border-color: var(--primary-color);
      background: rgba(139, 21, 56, 0.05);
    }

    .zone-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--dark-color);
      margin-bottom: 4px;
    }

    .zone-number {
      font-size: 14px;
      color: var(--medium-gray);
      margin-bottom: 8px;
    }

    .zone-actions {
      display: flex;
      gap: 8px;
    }

    /* Map Container */
    .map-container {
      flex: 1;
      background: white;
      border-radius: 20px;
      box-shadow: 0 8px 32px var(--shadow-light);
      overflow: hidden;
      position: relative;
    }

    .map-header {
      background: var(--gradient-primary);
      color: white;
      padding: 16px 20px;
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    #map {
      height: calc(100% - 60px);
      width: 100%;
    }

    /* Drawing Controls */
    .drawing-controls {
      position: absolute;
      top: 80px;
      left: 20px;
      z-index: 1000;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 15px var(--shadow-light);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .drawing-controls .btn {
      min-width: 120px;
    }

    /* Status Messages */
    .status-message {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 2000;
      padding: 16px 20px;
      border-radius: 12px;
      color: white;
      font-weight: 600;
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
      transform: translateX(400px);
      transition: transform 0.3s ease;
    }

    .status-message.show {
      transform: translateX(0);
    }

    .status-success {
      background: var(--success-color);
    }

    .status-error {
      background: var(--danger-color);
    }

    .status-warning {
      background: var(--warning-color);
      color: var(--dark-color);
    }

    .status-info {
      background: var(--info-color);
    }

    /* Loading Spinner */
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3000;
    }

    .loading-content {
      background: white;
      padding: 40px;
      border-radius: 20px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid var(--light-gray);
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
      .main-container {
        flex-direction: column;
        height: auto;
      }
      
      .sidebar {
        width: 100%;
        max-height: 400px;
      }
      
      .map-container {
        height: 500px;
      }
    }

    @media (max-width: 768px) {
      .main-container {
        padding: 10px;
        gap: 10px;
      }
      
      .sidebar {
        max-height: 300px;
      }
      
      .sidebar-content {
        padding: 15px;
      }
      
      .drawing-controls {
        position: relative;
        top: auto;
        left: auto;
        margin-bottom: 10px;
      }
    }

    /* Animation Classes */
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .bounce-in {
      animation: bounceIn 0.6s ease-out;
    }

    @keyframes bounceIn {
      0% { transform: scale(0.3); opacity: 0; }
      50% { transform: scale(1.05); }
      70% { transform: scale(0.9); }
      100% { transform: scale(1); opacity: 1; }
    }

    /* Custom Scrollbar */
    .sidebar-content::-webkit-scrollbar,
    .zone-list::-webkit-scrollbar {
      width: 6px;
    }

    .sidebar-content::-webkit-scrollbar-track,
    .zone-list::-webkit-scrollbar-track {
      background: var(--light-gray);
      border-radius: 3px;
    }

    .sidebar-content::-webkit-scrollbar-thumb,
    .zone-list::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 3px;
    }
  </style>
</head>
<body>

<div class="header">
  <h1><i class="fas fa-cogs"></i> لوحة إدارة مناطق قطر</h1>
  <div class="subtitle">إضافة وتعديل وإدارة المناطق الجغرافية</div>
</div>

<div class="main-container">
  <!-- Sidebar -->
  <div class="sidebar fade-in">
    <div class="sidebar-header">
      <i class="fas fa-tools"></i> أدوات الإدارة
    </div>
    
    <div class="sidebar-content">
      <!-- Tabs -->
      <div class="tabs">
        <div class="tab active" data-tab="add">
          <i class="fas fa-plus"></i> إضافة
        </div>
        <div class="tab" data-tab="manage">
          <i class="fas fa-list"></i> إدارة
        </div>
        <div class="tab" data-tab="settings">
          <i class="fas fa-cog"></i> إعدادات
        </div>
      </div>

      <!-- Add Zone Tab -->
      <div class="tab-content active" id="add-tab">
        <form id="add-zone-form">
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-map-marker-alt"></i> اسم المنطقة (عربي)
            </label>
            <input type="text" class="form-input" id="zone-arabic" placeholder="مثال: الدوحة" required>
          </div>

          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-globe"></i> اسم المنطقة (إنجليزي)
            </label>
            <input type="text" class="form-input" id="zone-english" placeholder="Example: Doha">
          </div>

          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-hashtag"></i> رقم المنطقة
            </label>
            <input type="text" class="form-input" id="zone-number" placeholder="مثال: 1" required>
          </div>

          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-info-circle"></i> وصف المنطقة
            </label>
            <textarea class="form-input form-textarea" id="zone-description" placeholder="وصف اختياري للمنطقة..."></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-draw-polygon"></i> الحدود الجغرافية
            </label>
            <div style="font-size: 14px; color: var(--medium-gray); margin-bottom: 12px;">
              استخدم أدوات الرسم على الخريطة لتحديد حدود المنطقة
            </div>
            <button type="button" class="btn btn-warning btn-full" id="start-drawing">
              <i class="fas fa-pencil-alt"></i> ابدأ الرسم على الخريطة
            </button>
          </div>

          <button type="submit" class="btn btn-success btn-full" id="save-zone">
            <i class="fas fa-save"></i> حفظ المنطقة
          </button>
        </form>
      </div>

      <!-- Manage Zones Tab -->
      <div class="tab-content" id="manage-tab">
        <div class="form-group">
          <label class="form-label">
            <i class="fas fa-search"></i> البحث في المناطق
          </label>
          <input type="text" class="form-input" id="search-zones" placeholder="ابحث عن منطقة...">
        </div>

        <div class="zone-list" id="zones-list">
          <!-- Zones will be loaded here -->
        </div>

        <div style="margin-top: 20px;">
          <button class="btn btn-primary btn-full" id="refresh-zones">
            <i class="fas fa-sync-alt"></i> تحديث القائمة
          </button>
        </div>
      </div>

      <!-- Settings Tab -->
      <div class="tab-content" id="settings-tab">
        <div class="form-group">
          <label class="form-label">
            <i class="fas fa-database"></i> إدارة البيانات
          </label>
          <button class="btn btn-info btn-full" id="export-data" style="margin-bottom: 10px;">
            <i class="fas fa-download"></i> تصدير البيانات
          </button>
          <button class="btn btn-warning btn-full" id="backup-data">
            <i class="fas fa-shield-alt"></i> نسخ احتياطي
          </button>
        </div>

        <div class="form-group">
          <label class="form-label">
            <i class="fas fa-eye"></i> عرض الخريطة الأساسية
          </label>
          <button class="btn btn-primary btn-full" id="view-main-map">
            <i class="fas fa-external-link-alt"></i> فتح الخريطة الرئيسية
          </button>
        </div>

        <div class="form-group">
          <label class="form-label">
            <i class="fas fa-info"></i> معلومات النظام
          </label>
          <div style="background: var(--light-gray); padding: 15px; border-radius: 8px; font-size: 14px;">
            <div><strong>إجمالي المناطق:</strong> <span id="total-zones">0</span></div>
            <div><strong>آخر تحديث:</strong> <span id="last-update">غير محدد</span></div>
            <div><strong>الإصدار:</strong> 1.0.1</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Map Container -->
  <div class="map-container fade-in">
    <div class="map-header">
      <span><i class="fas fa-map"></i> خريطة تحرير المناطق</span>
      <div>
        <button class="btn btn-sm btn-warning" id="clear-drawings">
          <i class="fas fa-eraser"></i> مسح الرسم
        </button>
      </div>
    </div>
    
    <div class="drawing-controls">
      <button class="btn btn-sm btn-primary" id="draw-polygon">
        <i class="fas fa-draw-polygon"></i> رسم منطقة
      </button>
      <button class="btn btn-sm btn-warning" id="edit-polygon">
        <i class="fas fa-edit"></i> تعديل
      </button>
      <button class="btn btn-sm btn-danger" id="delete-polygon">
        <i class="fas fa-trash"></i> حذف
      </button>
    </div>

    <div id="map"></div>
  </div>
</div>

<!-- Loading Overlay -->
<div class="loading" id="loading" style="display: none;">
  <div class="loading-content">
    <div class="spinner"></div>
    <div>جاري المعالجة...</div>
  </div>
</div>

<!-- Status Messages -->
<div class="status-message" id="status-message"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, get, set, push, remove, child } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyD3hShBlWYIFkhlpxezZi7ZsNoWUFoWQF4",
    authDomain: "delivery-tracker-a5493.firebaseapp.com",
    databaseURL: "https://delivery-tracker-a5493-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "delivery-tracker-a5493",
    storageBucket: "delivery-tracker-a5493.appspot.com",
    messagingSenderId: "168628360237",
    appId: "1:168628360237:web:b1657657eb8a19fe6054a4",
    measurementId: "G-YV01JCQ9WE"
  };

  // Global variables
  let map;
  let drawnItems;
  let drawControl;
  let currentDrawnLayer = null;
  let zones = [];
  let selectedZone = null;
  let db;
  let app;

  // Make variables accessible globally for debugging
  window.zones = zones;
  window.map = map;
  window.db = db;

  // DOM Elements
  const loadingElement = document.getElementById("loading");
  const statusMessage = document.getElementById("status-message");
  const addZoneForm = document.getElementById("add-zone-form");
  const zonesList = document.getElementById("zones-list");
  const searchZones = document.getElementById("search-zones");

  // Utility Functions
  function showLoading() {
    loadingElement.style.display = "flex";
  }

  function hideLoading() {
    loadingElement.style.display = "none";
  }

  function showStatus(message, type = 'info') {
    statusMessage.textContent = message;
    statusMessage.className = `status-message status-${type} show`;
    
    setTimeout(() => {
      statusMessage.classList.remove('show');
    }, 4000);
  }

  function generateId() {
    return 'area_' + Math.random().toString(36).substr(2, 9);
  }

  // Safe string conversion function
  function safeString(value) {
    if (value === null || value === undefined) {
      return '';
    }
    return String(value);
  }

  // Initialize Firebase
  async function initializeFirebase() {
    try {
      console.log("Initializing Firebase...");
      app = initializeApp(firebaseConfig);
      db = getDatabase(app);
      window.db = db;
      console.log("Firebase initialized successfully");
      return true;
    } catch (error) {
      console.error("Error initializing Firebase:", error);
      showStatus("خطأ في الاتصال بقاعدة البيانات", 'error');
      return false;
    }
  }

  // Initialize Leaflet Map
  function initializeMap() {
    try {
      map = L.map('map', {
        center: [25.3, 51.5],
        zoom: 10,
        zoomControl: false
      });

      // Add custom zoom control
      L.control.zoom({
        position: 'bottomleft'
      }).addTo(map);

      // Custom tile layer with better styling
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 18
      }).addTo(map);

      // Initialize drawn items layer
      drawnItems = new L.FeatureGroup();
      map.addLayer(drawnItems);

      // Initialize draw control
      drawControl = new L.Control.Draw({
        position: 'topright',
        draw: {
          polygon: {
            allowIntersection: false,
            drawError: {
              color: '#e1e100',
              message: '<strong>خطأ:</strong> لا يمكن أن تتقاطع حدود المنطقة!'
            },
            shapeOptions: {
              color: '#8B1538',
              weight: 3,
              fillOpacity: 0.2
            }
          },
          polyline: false,
          rectangle: false,
          circle: false,
          marker: false,
          circlemarker: false
        },
        edit: {
          featureGroup: drawnItems,
          remove: true
        }
      });

      map.addControl(drawControl);

      // Map events
      map.on(L.Draw.Event.CREATED, function(e) {
        const layer = e.layer;
        drawnItems.addLayer(layer);
        currentDrawnLayer = layer;
        
        showStatus('تم رسم المنطقة بنجاح! يمكنك الآن حفظ البيانات.', 'success');
      });

      map.on(L.Draw.Event.EDITED, function(e) {
        showStatus('تم تعديل المنطقة بنجاح!', 'success');
      });

      map.on(L.Draw.Event.DELETED, function(e) {
        currentDrawnLayer = null;
        showStatus('تم حذف الرسم.', 'warning');
      });

      window.map = map;
      console.log("Map initialized successfully");

    } catch (error) {
      console.error("Error initializing map:", error);
      showStatus("خطأ في تحميل الخريطة", 'error');
    }
  }

  // Load existing zones with improved error handling
  async function loadExistingZones() {
    try {
      showLoading();
      console.log("Loading zones from Firebase...");
      
      if (!db) {
        throw new Error("قاعدة البيانات غير متاحة");
      }

      const snapshot = await get(child(ref(db), 'areas'));
      
      zones.length = 0; // Clear existing zones
      
      if (snapshot.exists()) {
        const areas = snapshot.val();
        let loadedCount = 0;
        
        for (let id in areas) {
          try {
            const area = areas[id];

            // Validate area data
            if (!area.geometry) {
              console.warn(`Missing geometry for area ${id}`);
              continue;
            }

            // Extract properties with safe defaults
            let arabic = safeString(area.region || area.properties?.["المنطقة"] || "غير معروف");
            let english = safeString(area.english_name || "غير متوفر");
            let zone = safeString(area.name || area.properties?.["الاسم"] || area.zone || "غير معروف");

            const feature = {
              type: "Feature",
              geometry: area.geometry,
              properties: {
                id: area.id || id,
                arabic: arabic,
                english: english,
                zone: zone,
                description: safeString(area.description || "")
              }
            };

            zones.push({
              id: id,
              ...area,
              region: arabic,
              english_name: english,
              name: zone,
              zone: zone
            });
            
            // Add to map
            const layer = L.geoJSON(area.geometry, {
              style: {
                color: '#8B1538',
                weight: 2,
                fillOpacity: 0.1
              }
            }).addTo(map);
            
            layer.bindPopup(`
              <strong>${arabic}</strong><br>
              رقم: ${zone}
            `);
            
            loadedCount++;
            
          } catch (error) {
            console.warn(`Error processing area ${id}:`, error);
          }
        }

        console.log(`Loaded ${loadedCount} zones successfully`);
        showStatus(`تم تحميل ${loadedCount} منطقة بنجاح`, 'success');
      } else {
        console.log("No zones found in database");
        showStatus("لا توجد مناطق في قاعدة البيانات", 'info');
      }
      
      updateZonesList();
      updateStats();
      hideLoading();
      
    } catch (error) {
      console.error("Error loading zones:", error);
      hideLoading();
      showStatus("خطأ في تحميل المناطق: " + error.message, 'error');
    }
  }

  // Update zones list with improved error handling
  function updateZonesList() {
    try {
      const searchTerm = safeString(searchZones.value).toLowerCase();
      const filteredZones = zones.filter(zone => {
        const arabic = safeString(zone.region || zone.arabic || '').toLowerCase();
        const english = safeString(zone.english_name || zone.english || '').toLowerCase();
        const number = safeString(zone.name || zone.zone || '').toLowerCase();
        const description = safeString(zone.description || '').toLowerCase();
        
        return arabic.includes(searchTerm) || 
               english.includes(searchTerm) || 
               number.includes(searchTerm) ||
               description.includes(searchTerm);
      });

      zonesList.innerHTML = '';
      
      if (filteredZones.length === 0) {
        const noResultsItem = document.createElement('div');
        noResultsItem.className = 'zone-item';
        noResultsItem.innerHTML = `
          <div class="zone-name" style="text-align: center; opacity: 0.7;">
            <i class="fas fa-search"></i> لا توجد مناطق
          </div>
        `;
        zonesList.appendChild(noResultsItem);
        return;
      }
      
      filteredZones.forEach(zone => {
        const zoneItem = document.createElement('div');
        zoneItem.className = 'zone-item';
        zoneItem.innerHTML = `
          <div class="zone-name">${safeString(zone.region || zone.arabic || 'غير محدد')}</div>
          <div class="zone-number">رقم المنطقة: ${safeString(zone.name || zone.zone || 'غير محدد')}</div>
          <div class="zone-actions">
            <button class="btn btn-sm btn-warning" onclick="editZone('${zone.id}')">
              <i class="fas fa-edit"></i> تعديل
            </button>
            <button class="btn btn-sm btn-danger" onclick="deleteZone('${zone.id}')">
              <i class="fas fa-trash"></i> حذف
            </button>
          </div>
        `;
        
        zoneItem.addEventListener('click', (e) => {
          if (!e.target.closest('.zone-actions')) {
            selectZone(zone.id);
          }
        });
        
        zonesList.appendChild(zoneItem);
      });
    } catch (error) {
      console.error("Error updating zones list:", error);
      showStatus("خطأ في تحديث قائمة المناطق", 'error');
    }
  }

  // Update statistics
  function updateStats() {
    try {
      document.getElementById('total-zones').textContent = zones.length;
      document.getElementById('last-update').textContent = new Date().toLocaleString('ar-SA');
    } catch (error) {
      console.error("Error updating stats:", error);
    }
  }

  // Select zone
  function selectZone(zoneId) {
    try {
      // Remove previous selection
      document.querySelectorAll('.zone-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      // Add selection to clicked item
      if (event && event.currentTarget) {
        event.currentTarget.classList.add('selected');
      }
      
      selectedZone = zones.find(z => z.id === zoneId);
      
      if (selectedZone && selectedZone.geometry) {
        // Zoom to zone
        const layer = L.geoJSON(selectedZone.geometry);
        map.fitBounds(layer.getBounds(), { padding: [20, 20] });
        
        showStatus(`تم تحديد منطقة: ${safeString(selectedZone.region || selectedZone.arabic || 'غير محدد')}`, 'info');
      }
    } catch (error) {
      console.error("Error selecting zone:", error);
      showStatus("خطأ في تحديد المنطقة", 'error');
    }
  }

  // Edit zone
  window.editZone = function(zoneId) {
    try {
      const zone = zones.find(z => z.id === zoneId);
      if (!zone) {
        showStatus("المنطقة غير موجودة", 'error');
        return;
      }
      
      // Switch to add tab
      switchTab('add');
      
      // Fill form with zone data
      document.getElementById('zone-arabic').value = safeString(zone.region || zone.arabic || '');
      document.getElementById('zone-english').value = safeString(zone.english_name || zone.english || '');
      document.getElementById('zone-number').value = safeString(zone.name || zone.zone || '');
      document.getElementById('zone-description').value = safeString(zone.description || '');
      
      // Load geometry to map
      if (zone.geometry) {
        drawnItems.clearLayers();
        const layer = L.geoJSON(zone.geometry, {
          style: {
            color: '#FFD700',
            weight: 3,
            fillOpacity: 0.3
          }
        });
        drawnItems.addLayer(layer);
        currentDrawnLayer = layer;
        
        map.fitBounds(layer.getBounds(), { padding: [20, 20] });
      }
      
      // Change form to edit mode
      selectedZone = zone;
      document.getElementById('save-zone').innerHTML = '<i class="fas fa-save"></i> تحديث المنطقة';
      
      showStatus(`جاري تعديل منطقة: ${safeString(zone.region || zone.arabic || 'غير محدد')}`, 'info');
    } catch (error) {
      console.error("Error editing zone:", error);
      showStatus("خطأ في تعديل المنطقة", 'error');
    }
  };

  // Delete zone
  window.deleteZone = async function(zoneId) {
    try {
      const zone = zones.find(z => z.id === zoneId);
      const zoneName = safeString(zone?.region || zone?.arabic || 'المنطقة');
      
      if (!confirm(`هل أنت متأكد من حذف منطقة "${zoneName}"؟`)) return;
      
      showLoading();
      
      if (!db) {
        throw new Error("قاعدة البيانات غير متاحة");
      }
      
      await remove(ref(db, `areas/${zoneId}`));
      
      // Remove from local array
      const index = zones.findIndex(z => z.id === zoneId);
      if (index !== -1) {
        zones.splice(index, 1);
      }
      
      updateZonesList();
      updateStats();
      hideLoading();
      
      showStatus(`تم حذف منطقة "${zoneName}" بنجاح`, 'success');
      
      // Reload map
      setTimeout(() => {
        location.reload();
      }, 1500);
      
    } catch (error) {
      console.error("Error deleting zone:", error);
      hideLoading();
      showStatus('خطأ في حذف المنطقة: ' + error.message, 'error');
    }
  };

  // Save zone with improved validation and error handling
  async function saveZone(formData) {
    try {
      // Validate required fields
      if (!formData.arabic || !formData.arabic.trim()) {
        showStatus('يرجى إدخال اسم المنطقة بالعربية', 'warning');
        return;
      }
      
      if (!formData.number || !formData.number.trim()) {
        showStatus('يرجى إدخال رقم المنطقة', 'warning');
        return;
      }
      
      if (!currentDrawnLayer) {
        showStatus('يرجى رسم حدود المنطقة على الخريطة أولاً', 'warning');
        return;
      }

      // Check for duplicate zone number (only if not editing)
      if (!selectedZone) {
        const duplicateZone = zones.find(z => 
          safeString(z.name || z.zone) === formData.number.trim()
        );
        if (duplicateZone) {
          showStatus('رقم المنطقة موجود مسبقاً، يرجى اختيار رقم آخر', 'warning');
          return;
        }
      }

      showLoading();
      
      if (!db) {
        throw new Error("قاعدة البيانات غير متاحة");
      }
      
      const geometry = currentDrawnLayer.toGeoJSON().geometry;
      
      const zoneData = {
        region: formData.arabic.trim(),
        english_name: formData.english.trim() || 'غير متوفر',
        name: formData.number.trim(),
        zone: formData.number.trim(),
        description: formData.description.trim() || '',
        geometry: geometry,
        created_at: selectedZone?.created_at || new Date().toISOString(),
        updated_at: new Date().toISOString()
      };

      let zoneRef;
      if (selectedZone) {
        // Update existing zone
        zoneRef = ref(db, `areas/${selectedZone.id}`);
      } else {
        // Create new zone
        const newId = generateId();
        zoneRef = ref(db, `areas/${newId}`);
      }

      await set(zoneRef, zoneData);
      
      hideLoading();
      showStatus(selectedZone ? 'تم تحديث المنطقة بنجاح' : 'تم إضافة المنطقة بنجاح', 'success');
      
      // Reset form
      addZoneForm.reset();
      drawnItems.clearLayers();
      currentDrawnLayer = null;
      selectedZone = null;
      document.getElementById('save-zone').innerHTML = '<i class="fas fa-save"></i> حفظ المنطقة';
      
      // Reload zones
      setTimeout(() => {
        loadExistingZones();
      }, 1000);
      
    } catch (error) {
      console.error("Error saving zone:", error);
      hideLoading();
      showStatus('خطأ في حفظ المنطقة: ' + error.message, 'error');
    }
  }

  // Tab switching
  function switchTab(tabName) {
    try {
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      const targetTab = document.querySelector(`[data-tab="${tabName}"]`);
      if (targetTab) {
        targetTab.classList.add('active');
      }
      
      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      const targetContent = document.getElementById(`${tabName}-tab`);
      if (targetContent) {
        targetContent.classList.add('active');
      }
    } catch (error) {
      console.error("Error switching tab:", error);
    }
  }

  // Initialize application
  async function init() {
    try {
      console.log("Initializing application...");
      
      const firebaseInitialized = await initializeFirebase();
      if (!firebaseInitialized) {
        showStatus("تعذر الاتصال بقاعدة البيانات، سيتم العمل في وضع محدود", 'warning');
      }
      
      initializeMap();
      
      if (firebaseInitialized) {
        await loadExistingZones();
      }
      
      console.log("Application initialized successfully");
    } catch (error) {
      console.error("Initialization error:", error);
      showStatus("خطأ في تشغيل التطبيق: " + error.message, 'error');
    }
  }

  // Event Listeners
  document.addEventListener('DOMContentLoaded', function() {
    init();
    
    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', function() {
        const tabName = this.getAttribute('data-tab');
        switchTab(tabName);
      });
    });
    
    // Form submission
    addZoneForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = {
        arabic: document.getElementById('zone-arabic').value,
        english: document.getElementById('zone-english').value,
        number: document.getElementById('zone-number').value,
        description: document.getElementById('zone-description').value
      };
      
      saveZone(formData);
    });
    
    // Search zones
    searchZones.addEventListener('input', updateZonesList);
    
    // Drawing controls
    document.getElementById('start-drawing').addEventListener('click', function() {
      showStatus('انقر على "رسم منطقة" في أدوات الخريطة لبدء الرسم', 'info');
    });
    
    document.getElementById('clear-drawings').addEventListener('click', function() {
      drawnItems.clearLayers();
      currentDrawnLayer = null;
      showStatus('تم مسح جميع الرسوم', 'warning');
    });
    
    document.getElementById('refresh-zones').addEventListener('click', loadExistingZones);
    
    document.getElementById('view-main-map').addEventListener('click', function() {
      window.open('qatar_map_perfect.html', '_blank');
    });
    
    document.getElementById('export-data').addEventListener('click', function() {
      try {
        const dataStr = JSON.stringify(zones, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `qatar_zones_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        URL.revokeObjectURL(url);
        
        showStatus('تم تصدير البيانات بنجاح', 'success');
      } catch (error) {
        console.error("Error exporting data:", error);
        showStatus('خطأ في تصدير البيانات', 'error');
      }
    });
    
    document.getElementById('backup-data').addEventListener('click', function() {
      showStatus('جاري إنشاء نسخة احتياطية...', 'info');
      setTimeout(() => {
        try {
          const backup = {
            zones: zones,
            timestamp: new Date().toISOString(),
            version: '1.0.1'
          };
          
          const backupData = JSON.stringify(backup, null, 2);
          const dataBlob = new Blob([backupData], {type: 'application/json'});
          const url = URL.createObjectURL(dataBlob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `qatar_zones_backup_${new Date().toISOString().split('T')[0]}.json`;
          link.click();
          URL.revokeObjectURL(url);
          
          showStatus('تم إنشاء النسخة الاحتياطية بنجاح', 'success');
        } catch (error) {
          console.error("Error creating backup:", error);
          showStatus('خطأ في إنشاء النسخة الاحتياطية', 'error');
        }
      }, 2000);
    });
  });
</script>

</body>
</html>

